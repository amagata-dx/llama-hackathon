// è¦³å¯Ÿè¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
import { useState } from 'react'
import { Save, AlertCircle, Mic, Sparkles, Loader2 } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { StudentSelector } from './student-selector'
import { TagDisplay } from './tag-display'
import { VoiceRecorder } from './voice-recorder'
import { TextImprovementPanel } from './text-improvement-panel'
import type { StudentReference, Tag, ObservationType, PriorityLevel, InputMethod } from '@/types'
import { tagCategories, priorityColors } from '@/data/tag-categories'
import { analyzeObservation, generateMockAnalysis } from '@/lib/ai/tag-analyzer'
import { toast } from 'sonner'

interface ObservationFormProps {
  onSubmit: (data: ObservationFormData) => void
  isSubmitting?: boolean
}

export interface ObservationFormData {
  students: StudentReference[]
  content: {
    text: string
    audioBlob?: Blob
    audioUrl?: string
    duration?: number
  }
  type: ObservationType
  tags: Tag[]
  priority: PriorityLevel
  location?: string
  templateId?: string
  inputMethod: InputMethod
  isOfflineCreated: boolean
  teacherId: string
  aiAnalysis?: {
    sentiment: number
    keywords: string[]
    suggestedActions: string[]
    confidence: number
  }
}

export function ObservationForm({ onSubmit, isSubmitting = false }: ObservationFormProps) {
  // ãƒ•ã‚©ãƒ¼ãƒ ã®çŠ¶æ…‹ç®¡ç†
  const [students, setStudents] = useState<StudentReference[]>([])
  const [contentText, setContentText] = useState('')
  const [type, setType] = useState<ObservationType>('behavioral')
  const [tags, setTags] = useState<Tag[]>([])
  const [priority, setPriority] = useState<PriorityLevel>('normal')
  const [location, setLocation] = useState('')
  const [errors, setErrors] = useState<Record<string, string>>({})
  const [useVoiceInput, setUseVoiceInput] = useState(false)
  const [audioBlob, setAudioBlob] = useState<Blob | null>(null)

  // AIåˆ†æã®çŠ¶æ…‹ç®¡ç†
  const [isAnalyzing, setIsAnalyzing] = useState(false)
  const [aiAnalysis, setAiAnalysis] = useState<ObservationFormData['aiAnalysis'] | null>(null)
  const [showAiSuggestions, setShowAiSuggestions] = useState(false)

  // ãƒ†ã‚­ã‚¹ãƒˆæ”¹å–„ã®çŠ¶æ…‹ç®¡ç†
  const [textImprovements, setTextImprovements] = useState<{
    original?: string
    restructured?: string
    summary?: string
  }>({})
  const [showTextImprovement, setShowTextImprovement] = useState(false)
  const [isFromVoiceInput, setIsFromVoiceInput] = useState(false)

  // éŸ³å£°å…¥åŠ›ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’å—ã‘å–ã‚‹
  const handleVoiceTranscript = async (transcript: string, blob?: Blob) => {
    console.log('éŸ³å£°èªè­˜çµæœã‚’å—ä¿¡:', transcript)

    if (!transcript || !transcript.trim()) {
      console.warn('ç©ºã®éŸ³å£°èªè­˜çµæœã‚’å—ä¿¡')
      toast.error('éŸ³å£°èªè­˜çµæœãŒç©ºã§ã™ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚')
      return
    }

    setContentText(transcript)
    if (blob) {
      setAudioBlob(blob)
    }

    // ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆç‰¹ã«è¦³å¯Ÿå†…å®¹ã®ã‚¨ãƒ©ãƒ¼ï¼‰
    setErrors(prev => {
      const newErrors = { ...prev }
      delete newErrors.content
      return newErrors
    })

    // éŸ³å£°å…¥åŠ›å¾Œã¯æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
    setUseVoiceInput(false)
    setIsFromVoiceInput(true)

    // è‡ªå‹•åˆ†æã¯å®Ÿè¡Œã›ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã®ã‚’å¾…ã¤
    toast.info('éŸ³å£°å…¥åŠ›ãŒå®Œäº†ã—ã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦AIåˆ†æãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚')
  }

  // AIåˆ†æã®å®Ÿè¡Œ
  const handleAiAnalysis = async (includeTextImprovement: boolean = false) => {
    if (!contentText.trim()) {
      toast.error('è¦³å¯Ÿå†…å®¹ã‚’å…¥åŠ›ã—ã¦ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„')
      return
    }

    setIsAnalyzing(true)
    setShowAiSuggestions(false)
    setShowTextImprovement(false)

    try {
      // ç”Ÿå¾’åã‚’å–å¾—
      const studentNames = students.map(s => s.name)

      // AIåˆ†æã‚’å®Ÿè¡Œï¼ˆéŸ³å£°å…¥åŠ›ã®å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆæ”¹å–„ã‚‚å«ã‚€ï¼‰
      const result = await analyzeObservation(
        contentText,
        studentNames,
        location,
        includeTextImprovement || isFromVoiceInput
      )

      if (result) {
        // åˆ†æçµæœã‚’é©ç”¨
        setTags([...tags.filter(t => !t.isAutoGenerated), ...result.tags])
        setPriority(result.priority)
        setType(result.type)
        if (result.location && !location) {
          setLocation(result.location)
        }
        setAiAnalysis(result.aiAnalysis)
        setShowAiSuggestions(true)

        // ãƒ†ã‚­ã‚¹ãƒˆæ”¹å–„çµæœã‚’è¨­å®š
        if (result.restructuredText || result.summary) {
          setTextImprovements({
            original: result.originalText || contentText,
            restructured: result.restructuredText,
            summary: result.summary
          })
          setShowTextImprovement(true)
        }

        const message = includeTextImprovement
          ? 'AIåˆ†æã¨ãƒ†ã‚­ã‚¹ãƒˆæ”¹å–„ãŒå®Œäº†ã—ã¾ã—ãŸ'
          : 'AIåˆ†æãŒå®Œäº†ã—ã¾ã—ãŸ'

        toast.success(message, {
          description: `${result.tags.length}å€‹ã®ã‚¿ã‚°ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼ˆä¿¡é ¼åº¦: ${Math.round(result.aiAnalysis.confidence * 100)}%ï¼‰`
        })
      } else {
        // APIã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ¢ãƒƒã‚¯åˆ†æã‚’ä½¿ç”¨
        console.warn('AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ¢ãƒƒã‚¯åˆ†æã‚’ä½¿ç”¨ã—ã¾ã™ã€‚')
        const mockResult = generateMockAnalysis(contentText)

        setTags([...tags.filter(t => !t.isAutoGenerated), ...mockResult.tags])
        setPriority(mockResult.priority)
        setType(mockResult.type)
        setAiAnalysis(mockResult.aiAnalysis)
        setShowAiSuggestions(true)

        toast.warning('AIåˆ†æã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ', {
          description: 'ç°¡æ˜“åˆ†æã‚’å®Ÿè¡Œã—ã¾ã—ãŸ'
        })
      }
    } catch (error) {
      console.error('AIåˆ†æã‚¨ãƒ©ãƒ¼:', error)
      toast.error('AIåˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setIsAnalyzing(false)
    }
  }

  // ãƒ†ã‚­ã‚¹ãƒˆæ”¹å–„çµæœã‚’ä½¿ç”¨
  const handleUseImprovedText = (text: string) => {
    setContentText(text)
    setShowTextImprovement(false)

    // æ”¹å–„ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ã—ãŸã‚‰contentã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (text.trim() && errors.content) {
      setErrors(prev => {
        const newErrors = { ...prev }
        delete newErrors.content
        return newErrors
      })
    }

    toast.success('æ”¹å–„ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚’é©ç”¨ã—ã¾ã—ãŸ')
  }

  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const validate = (): boolean => {
    const newErrors: Record<string, string> = {}

    if (students.length === 0) {
      newErrors.students = 'ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„'
    }

    if (!contentText.trim()) {
      newErrors.content = 'è¦³å¯Ÿå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'
    }

    setErrors(newErrors)
    return Object.keys(newErrors).length === 0
  }

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()

    if (!validate()) {
      return
    }

    const formData: ObservationFormData = {
      students,
      content: {
        text: contentText.trim(),
        audioBlob: audioBlob || undefined,
      },
      type,
      tags,
      priority,
      location: location.trim() || undefined,
      inputMethod: audioBlob ? 'voice' : 'text',
      isOfflineCreated: false,
      teacherId: 'teacher-001', // TODO: å®Ÿéš›ã®æ•™å“¡IDã‚’ä½¿ç”¨
      aiAnalysis: aiAnalysis || undefined,
    }

    onSubmit(formData)
  }

  // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
  const resetForm = () => {
    setStudents([])
    setContentText('')
    setType('behavioral')
    setTags([])
    setPriority('normal')
    setLocation('')
    setErrors({})
    setAudioBlob(null)
    setUseVoiceInput(false)
    setAiAnalysis(null)
    setShowAiSuggestions(false)
    setTextImprovements({})
    setShowTextImprovement(false)
    setIsFromVoiceInput(false)
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>æ–°ã—ã„è¦³å¯Ÿè¨˜éŒ²</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-6">
          {/* ç”Ÿå¾’é¸æŠ */}
          <div>
            <StudentSelector
              selectedStudents={students}
              onStudentsChange={(newStudents) => {
                setStudents(newStudents)
                // ç”Ÿå¾’ãŒé¸æŠã•ã‚ŒãŸã‚‰studentsã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                if (newStudents.length > 0 && errors.students) {
                  setErrors(prev => {
                    const newErrors = { ...prev }
                    delete newErrors.students
                    return newErrors
                  })
                }
              }}
              multiple={true}
              required={true}
            />
            {errors.students && (
              <p className="text-sm text-red-500 mt-1 flex items-center gap-1">
                <AlertCircle className="h-3 w-3" />
                {errors.students}
              </p>
            )}
          </div>

          {/* è¦³å¯Ÿå†…å®¹ */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <Label htmlFor="content">
                è¦³å¯Ÿå†…å®¹ <span className="text-red-500">*</span>
              </Label>
              <Button
                type="button"
                variant={useVoiceInput ? 'default' : 'outline'}
                size="sm"
                onClick={() => setUseVoiceInput(!useVoiceInput)}
              >
                <Mic className="h-4 w-4 mr-1" />
                {useVoiceInput ? 'éŸ³å£°å…¥åŠ›ä¸­' : 'éŸ³å£°å…¥åŠ›'}
              </Button>
            </div>

            {useVoiceInput ? (
              <VoiceRecorder
                onTranscriptComplete={handleVoiceTranscript}
                placeholder="è¦³å¯Ÿã—ãŸå†…å®¹ã‚’éŸ³å£°ã§å…¥åŠ›..."
              />
            ) : (
              <>
                <Textarea
                  id="content"
                  placeholder="è¦³å¯Ÿã—ãŸå†…å®¹ã‚’è©³ã—ãè¨˜å…¥ã—ã¦ãã ã•ã„..."
                  value={contentText}
                  onChange={(e) => {
                    setContentText(e.target.value)
                    // å…¥åŠ›ãŒã‚ã£ãŸã‚‰contentã®ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
                    if (e.target.value.trim() && errors.content) {
                      setErrors(prev => {
                        const newErrors = { ...prev }
                        delete newErrors.content
                        return newErrors
                      })
                    }
                  }}
                  rows={4}
                  className="mt-1"
                  data-testid="observation-content"
                />
                {contentText && audioBlob && (
                  <p className="text-xs text-blue-600 mt-1">
                    éŸ³å£°å…¥åŠ›ã‹ã‚‰å¤‰æ›ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã§ã™
                  </p>
                )}
              </>
            )}

            {errors.content && (
              <p className="text-sm text-red-500 mt-1 flex items-center gap-1">
                <AlertCircle className="h-3 w-3" />
                {errors.content}
              </p>
            )}

            {/* AIåˆ†æãƒœã‚¿ãƒ³ */}
            {contentText && (
              <div className="mt-3 space-y-2">
                <div className="flex gap-2">
                  <Button
                    type="button"
                    variant={isFromVoiceInput ? "outline" : "secondary"}
                    size="sm"
                    onClick={() => handleAiAnalysis(false)}
                    disabled={isAnalyzing}
                    data-testid="ai-analyze-btn"
                  >
                    {isAnalyzing ? (
                      <>
                        <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                        AIåˆ†æä¸­...
                      </>
                    ) : (
                      <>
                        <Sparkles className="h-4 w-4 mr-2" />
                        AIã§è‡ªå‹•ã‚¿ã‚°ä»˜ã‘
                      </>
                    )}
                  </Button>
                  <Button
                    type="button"
                    variant={isFromVoiceInput ? "secondary" : "outline"}
                    size="sm"
                    onClick={() => handleAiAnalysis(true)}
                    disabled={isAnalyzing}
                    data-testid="ai-improve-btn"
                  >
                    {isAnalyzing ? (
                      <>
                        <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                        å‡¦ç†ä¸­...
                      </>
                    ) : (
                      <>
                        <Sparkles className="h-4 w-4 mr-2" />
                        ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢
                        {isFromVoiceInput && <span className="ml-1 text-xs">(æ¨å¥¨)</span>}
                      </>
                    )}
                  </Button>
                </div>
                {isFromVoiceInput && !showAiSuggestions && (
                  <p className="text-xs text-blue-600 flex items-center gap-1">
                    ğŸ’¡ éŸ³å£°å…¥åŠ›ã®å ´åˆã¯ã€Œãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢ã€ã§å¥èª­ç‚¹ã‚„æ–‡æ³•ã‚’è‡ªå‹•ä¿®æ­£ã§ãã¾ã™
                  </p>
                )}
                {showAiSuggestions && aiAnalysis && (
                  <p className="text-xs text-green-600 flex items-center gap-1">
                    <Sparkles className="h-3 w-3" />
                    AIåˆ†æå®Œäº†ï¼ˆä¿¡é ¼åº¦: {Math.round(aiAnalysis.confidence * 100)}%ï¼‰
                  </p>
                )}
              </div>
            )}

            {/* ãƒ†ã‚­ã‚¹ãƒˆæ”¹å–„ãƒ‘ãƒãƒ« */}
            {showTextImprovement && (
              <div className="mt-3">
                <TextImprovementPanel
                  originalText={textImprovements.original}
                  restructuredText={textImprovements.restructured}
                  summary={textImprovements.summary}
                  onUseText={handleUseImprovedText}
                  isVisible={showTextImprovement}
                />
              </div>
            )}
          </div>

          {/* ã‚«ãƒ†ã‚´ãƒªé¸æŠ */}
          <div>
            <Label htmlFor="type">ã‚«ãƒ†ã‚´ãƒª</Label>
            <select
              id="type"
              value={type}
              onChange={(e) => setType(e.target.value as ObservationType)}
              className="w-full px-3 py-2 border rounded-md mt-1"
              data-testid="observation-type"
            >
              {Object.entries(tagCategories).map(([key, info]) => (
                <option key={key} value={key}>
                  {info.icon} {info.label} - {info.description}
                </option>
              ))}
            </select>
          </div>

          {/* å„ªå…ˆåº¦é¸æŠ */}
          <div>
            <Label htmlFor="priority">å„ªå…ˆåº¦</Label>
            <div className="flex gap-2 mt-1">
              {Object.entries(priorityColors).map(([key, info]) => (
                <button
                  key={key}
                  type="button"
                  onClick={() => setPriority(key as PriorityLevel)}
                  className={`px-4 py-2 rounded-md text-sm font-medium transition-colors ${
                    priority === key
                      ? `${info.bgColor} ${info.color} ring-2 ring-offset-2 ring-blue-500`
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                  data-testid={`priority-${key}`}
                >
                  {info.label}
                </button>
              ))}
            </div>
          </div>

          {/* å ´æ‰€ */}
          <div>
            <Label htmlFor="location">å ´æ‰€ï¼ˆä»»æ„ï¼‰</Label>
            <Input
              id="location"
              type="text"
              placeholder="ä¾‹: æ•™å®¤ã€å»Šä¸‹ã€ä½“è‚²é¤¨..."
              value={location}
              onChange={(e) => setLocation(e.target.value)}
              className="mt-1"
              data-testid="observation-location"
            />
          </div>

          {/* ã‚¿ã‚° */}
          <TagDisplay
            tags={tags}
            onTagsChange={setTags}
            allowEdit={true}
            showCategory={true}
          />

          {/* AIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */}
          {showAiSuggestions && aiAnalysis && aiAnalysis.suggestedActions.length > 0 && (
            <div className="border-l-4 border-blue-400 bg-blue-50 p-4 rounded-r-lg">
              <div className="flex items-center gap-2 mb-2">
                <Sparkles className="h-4 w-4 text-blue-600" />
                <span className="text-sm font-medium text-blue-900">AIæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</span>
              </div>
              <ul className="space-y-1">
                {aiAnalysis.suggestedActions.map((action, index) => (
                  <li key={index} className="text-sm text-blue-700 flex items-start gap-1.5">
                    <span className="text-blue-400 mt-0.5">â€¢</span>
                    <span>{action}</span>
                  </li>
                ))}
              </ul>
              {aiAnalysis.keywords.length > 0 && (
                <div className="mt-3 pt-3 border-t border-blue-200">
                  <p className="text-xs text-blue-600 mb-1">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</p>
                  <div className="flex flex-wrap gap-1">
                    {aiAnalysis.keywords.map((keyword, index) => (
                      <span
                        key={index}
                        className="inline-block px-2 py-0.5 text-xs bg-blue-100 text-blue-700 rounded"
                      >
                        {keyword}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* ãƒœã‚¿ãƒ³ */}
          <div className="flex gap-3">
            <Button
              type="submit"
              disabled={isSubmitting}
              data-testid="save-observation"
            >
              {isSubmitting ? (
                <>
                  <span className="animate-spin mr-2">â³</span>
                  ä¿å­˜ä¸­...
                </>
              ) : (
                <>
                  <Save className="h-4 w-4 mr-2" />
                  è¨˜éŒ²ã‚’ä¿å­˜
                </>
              )}
            </Button>
            <Button
              type="button"
              variant="outline"
              onClick={resetForm}
              disabled={isSubmitting}
            >
              ãƒªã‚»ãƒƒãƒˆ
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  )
}